<html>
<head>
<link rel="stylesheet" href="js/CodeMirror-2.22/lib/codemirror.css" />
<link rel="stylesheet" href="js/CodeMirror-2.22/theme/elegant.css" />
<link rel="stylesheet" type="text/css" href="css/Aristo/Aristo.css" />
<link rel="stylesheet" type="text/css" href="js/gritter/css/jquery.gritter.css" />
<!--<link rel="stylesheet" type="text/css" href="js/jquery/css/flick/jquery-ui-1.8.16.custom.css" />-->

<script type="text/javascript" src="js/jquery/js/jquery-1.6.2.min.js"></script>
<script type="text/javascript" src="js/jquery/js/jquery-ui-1.8.16.custom.min.js"></script>

<script type="text/javascript" src="js/CodeMirror-2.22/lib/codemirror.js"></script>
<script type="text/javascript" src="js/CodeMirror-2.22/mode/javascript/javascript.js"></script>
<script type="text/javascript" src="js/gritter/js/jquery.gritter.js"></script>
<script type="text/javascript" src="js/writearduino.js"></script>

<style type="text/css">


        body{
margin:0;
padding:0;
line-height: 1.5em;
font-family: sans 
}

b{font-size: 110%;}
em{color: red;}


#topsection{
//background: #EAEAEA;
height: 10px; /*Height of top section*/
}

#topsection h1{
margin: 0;
padding-top: 15px;
}

#columnwrapper{
float: left;
width: 100%;
}

#rightcolumn{
margin: 0 52% 0 15%; /*Margins for right column. Should be "0 contentcolumnWidth 0 rightcolumnWidth*/
//background: #FDE95E;
}

#leftcolumn{
float: left;
width: 10%; /*Width of left column in percentage*/
margin-left: -100%;
//background: #C8FC98;
}

#contentcolumn{
float: left;
width: 42%; /*Width of right column in percentage*/
margin-left: -45%; /*Set margin to -(contentcolumnWidth)*/
}

#footer{
clear: left;
width: 100%;
//background: black;
color: #FFF;
text-align: center;
padding: 4px 0;
}

#footer a{
color: #FFFF80;
}

.innertube{
margin: 10px; /*Margins for inner DIV inside each column (to provide padding)*/
margin-top: 0;
}



	#scriptTarget { width: 200px; height: 30px;  
	  text-align: center; 
	   font-size: 12px; overflow: hidden; margin: 10px; }
	#monitorTarget { width: 200px; height:30px;  
	  text-align: center; 
	   font-size: 12px; overflow: hidden; margin: 10px; }
	   #sendTarget  { width: 200px; height:30px;  
	  text-align: center; 
	   font-size: 12px; overflow: hidden; margin: 10px; }
	#arduinoList { width: 150px; height: 150px; border: 1px #ccc;border-radius: 2px; 
	}
	.arduino { border-color: #76EE00;background-color: #CFCFCF;color:#FAFAFA; padding: 10px; margin: 5px;
	           font-size: 12px; font-weight: bold;
	          box-shadow: 2px 2px 2px #888;
	          -webkit-box-shadow: 2px 2px 2px #888;
	          -moz-box-shadow: 2px 2px 2px #888;
	          -o-box-shadow: 2px 2px 2px #888;
	         -ms-box-shadow: 2px 2px 2px #888;
	}
	.arduino:hover{ cursor:pointer; color: black;}
	
	
	.bordered { border: 1px ;border-radius: 4px;}
	.shadowed { -moz-box-shadow: 0 0 5px #888;
	            -webkit-box-shadow: 0 0 5px#888;
                    -o-box-shadow: 0 0 5px #888;
                   -ms-box-shadow: 0 0 5px #888;
                    box-shadow: 0 0 5px #888;}
                    #scriptTarget { border-color: #ccc}
                    
                    #createMonitor{ width: 150px; height: 20px;  padding-top: 10px;
	  text-align: center; 
	            font-size: 12px; overflow: hidden; margin: 10px;}
	        
	            
</style>
<script>

var scriptEditor;
var scripts = new Array();


$(document).ready( function(){

     scriptEditor = CodeMirror.fromTextArea(document.getElementById("scriptEditor"), {lineNumbers: true,
      theme: "elegant",
     lineWrapping: true});
  
             
       $.extend($.gritter.options, { 
        position: 'bottom-left', // defaults to 'top-right' but can be 'bottom-left', 'bottom-right', 'top-left', 'top-right' (added in 1.7.1)
	fade_in_speed: 'fast', // how fast notifications fade in (string or int)
	fade_out_speed: 1000, // how fast the notices fade out
	time: 2500,
	
});
       $.post("arduinolist.php", function( data ){
                        
                       var response = JSON.parse( data );
                    
                      var len = response.length;
                      $('.arduino').remove();
                   //   alert( len );
                      for( name in response )
                      {
                     //    alert( name + " " + response[name].address + " " + response[name].port);
                         $('#arduinoList').append('<p id="'+name+'" class="arduino bordered" title="'+ response[name].address+':'+response[name].port+'">'+name+'</p>');
                         $('#'+name).draggable({ helper:'clone', revert:'invalid', zIndex:2700,
                         cursor: "move", cursorAt: { top: 20, left: 46 }});
                        
                      }
                   
                    // $('#arduino1').draggable();
         });
         
       
        
         $(function() {
                       
		$( "#scriptTarget" ).droppable({
		        activeClass: 'ui-state-highlight', 
		        accept: '.arduino',
		        tolerance: 'pointer',
		        
			drop: function( event, ui ) {
		              var id = $(ui.draggable).attr('id');
		              $('#scriptTarget').html( id );
		              $('#scriptTarget').attr( 'title', $(ui.draggable).attr('title'));
		              $('#uploadButton').button("option","disabled", false);
		              
		              
			}
		});
		
		$( "#monitorTarget" ).droppable({
		        activeClass: 'ui-state-highlight', 
		        accept: '.arduino',
		        tolerance: 'pointer',
		        drop: function( event, ui ){
		                
		           $('#monitorTable').append('<tr><td>'+$(ui.draggable).attr('id')+'</td><td>'+
		                              $(ui.draggable).attr('title')+'</td></tr>');
		        }
		});
		      
	});
	 
	 $('#uploadButton').button({disabled:false});
	
	 $('#uploadButton').click( function(){

	        var target = $('#scriptTarget').html();
	        
	        if( target == "drag and drop to upload script" )
	        {
	          $.gritter.add({
	               title: "Upload Script",
                       text: "Drag and drop an Arduino to upload script to it"
                  });        
	                
	        }
	        else
	        {
	            var scriptName = $('#fileName').val();
	            scriptName = $.trim( scriptName );
	            
	            var scriptContents = scriptEditor.getValue();
	            scriptContents = $.trim(scriptContents);
	           
	            if( scriptContents == undefined ||
	                scriptContents.length == 0)
	            {
	               $.gritter.add({
	               title: "Upload Script",
                       text: "You must select a script to upload"
                      });
	            }
	            else
	            {
	               var ipaddressTarget = $('#scriptTarget').attr( 'title');
	               scriptContents = "<script>"+scriptContents+"<\/script>";
	               ipaddressTarget = ipaddressTarget.split(":");
	               $('#uploadButton').button("option","disabled",true);
	               
	                $.gritter.add({
	               title: "Uploading Script",
                       text: "..please wait"
                      });
	            
	               $.post("scriptupload.php", { ipaddress:ipaddressTarget[0],
	                               port:ipaddressTarget[1],
	               script:scriptContents}, function( data ){
	                       
	                       alert( data );
	                       try{
	                        data = JSON.parse( data );        
	                            
	                        if( data.reply == "error" )
	                        {
	                             $.gritter.add({
	                                             title: "Uploading Script: Error",
	                                 text: "..unable to connect to Arduino"
                                    });    
	                                      
	                        }
	                        else if( data.reply == "OK" )
	                        {
	                           $.gritter.add({
	                                  title: "Uploading Script",
	                                 text: "..script uploaded."
                                    });      
	                                
	                        }
	                       
	                       }catch( err ){
	                          console.log( err );
	                       }
	                 
	              // $('#scriptTarget').html("drag and drop to upload script");      
	              
	                       
	                       
	               }).complete( function(){
	                       
	                  $('#uploadButton').button("option","disabled", false);     
	               });
	            }
	                
	        }
	            
	 });
	 
	 $('#saveButton').button({disabled:false});
	 $('#deleteButton').button({disabled:false});
	 $('#clearButton').button({disabled:false});
	 
	 $('#clearButton').click( function(){
	                 
	     scriptEditor.setValue("");             
	 });
	 
	 
	 $('#deleteButton').click( function(){
	    
	     var scriptName = $('#fileName').val();
	     var scriptInList = false;
	     var scriptToDelete = null;
	     
	     scriptName = $.trim( scriptName );
	     
	     $('#fileList > option').each( function(){
	                       
	        if( this.value.toLowerCase() == scriptName.toLowerCase() )
	        {
	            scriptToDelete = $(this);
	            scriptInList = true;
	            return false;
	             
	        }
	     });
	     
	     if( scriptInList && scriptName !='..')
	     {
	             $.post( "scriptdelete.php", { name : scriptName },
	                   function( data )
	                   {
	                      var response = "";
	                      try{
	                        response = JSON.parse( data ); 
	                              
	                      }catch( err ){
	                         console.log( error );       
	                      }
	                   
	                      
	                      if( response.reply == "OK" )
	                      {
	                        $.gritter.add({
	                           title: "Deleting Script: " + scriptName,
                                   text: "..script deleted"
                                   
                                  
                                 });    
	                          $(scriptToDelete).remove(); 
	                          var tmp = $('#fileList').val();
	                          $('#fileName').val( "" );
	                          scriptEditor.setValue("");
	                      }
	                      else
	                      {
	                          $.gritter.add({
	                              title: "Delete Script: " + scriptName,
                                      text: "A problem has occurred accessing the database. Script Not Deleted."
                                   });   
                              }   
	                           
	                   }
	                   ).error( function(){
	                      $.gritter.add({
	                              title: "Delete Script: " + scriptName,
                                      text: "A network error occurred. Script Not Deleted."
                                   });      
	                           
	                           
	                   });
	             
	             
	             
	     }
	     
	                 
	 });
	 
	 
	 $('#fileList').change(function(){
	       var selectedFileName = $(this).val();
	       selectedFileName = $.trim( selectedFileName);
	       
	       if( selectedFileName.length > 0 )
	       {
	         if( selectedFileName == "..")
	         {
	           $('#fileName').val( "");
	           scriptEditor.setValue("");
	         }
	         else
	         {
	           $('#fileName').val( selectedFileName);
	           scriptEditor.setValue( scripts[selectedFileName] );
	         }
	       }
	 });
	 
	 $('#fileName').change( function(){
	         var fileName = $(this).val();
	         fileName = $.trim( fileName );
	         fileContents = scriptEditor.getValue();
	         fileContents = $.trim( fileContents );
	         
	     
	 });
	 
	 
	 $('#saveButton').click( function(){
	    var fileName = $('#fileName').val();
	    fileName = $.trim( fileName );
	   
	    if( fileName == ".." )
	    {
	      $.gritter.add({
	            title: "Invalid Script Name: " + fileName,
                    text: "Not permitted to use .. as a Script Name"
                  });         
	            
	    }
	    else if( fileName.length > 0 && fileName.length <= 40  )
	    {
	            var contents =scriptEditor.getValue();
	            contents = $.trim( contents );
	            
	            var saveMode = "save";
	            
	            $('#fileList > option').each( function(){
	                          
	             if( this.value.toLowerCase() == fileName.toLowerCase() )
	               {
	                             saveMode = "update";
	                             return false;
	               }
	             });
	            
	               $.gritter.add({
	                              title: "Saving Script: " + fileName,
                                      text: "sending to database..."
                                   });
	            
	            $.post("scriptpersist.php",
	                    {mode:saveMode, name:fileName, content:contents},
	                    function( data){
	                       var newScript = true;
                              
	                       var response ="";
	                       
	                       try{
	                         response = JSON.parse( data );
	                       }catch(err ){
	                          console.log( err );
	                       }
	                                       
	                       if( response.reply == "OK" )
	                       {        
	                          scripts[fileName]=contents;
	                          $('#fileList').val( fileName );
	                           if( saveMode == "save" )
	                           {
	                             var newScript = '<option class=".script" value="'+fileName+'">'+fileName+'</option>';
	                           
	                             $('#fileList').append( newScript );
	                             $('#fileList').val( fileName );
	                           }
	                           
	                            $.gritter.add({
	                              title: "Saving Script: " + fileName,
                                      text: "..stored in databse"
                                   });
	                       }
	                       else
	                       {
	                           $.gritter.add({
	                              title: "Saving Script: " + fileName,
                                      text: "A problem has occurred accessing the database. Script Not Saved"
                                   });     
	                               
	                       }
	            
	                    });
	                    
	                    
	               
	                    
	                    
	    }
	    else
	    {
	        $.gritter.add({
                    title: "Invalid Script Name",
                  text: "script name must be between 1 and 40 characters in length."
                  });
                
	            
	            
	    }
	    
	                 
	                 
	 }).error( function(){
	                      $.gritter.add({
	                              title: "Saving Script: " + scriptName,
                                      text: "A network error occurred. Script Not Deleted."
                                   });      
	                           
	                           
	                   });
	 
	 
	 $.get("scriptrestore.php", function( data ){
	                 
	      var response = "";
	      try{
	        response = JSON.parse( data );       
	      }catch( err ){ 
	          console.log( err );
	      }
	               
	      for( name in response )
	      {
	              scripts[ name ] = response[name];
	              var script = '<option class=".script" value="'+name+'">'+name+'</option>';
	              $('#fileList').append( script );
	              
	      }
      
	 });
	 
	 scriptEditor.refresh();
});





</script>
</head>


<body>
<div id="maincontainer">

<div id="topsection"><div class="innertube"></div></div>

<div id="columnwrapper">
<div id="rightcolumn"  >
<div class="innertube">

  <div id="monitorTarget" style="border: solid 1px #ccc; margin-left:0; border-radius: 2px;">
 monitor arduino</div>
  <div>
    <table id="monitorTable">
    
    
    </table>
  
  
  </div>

</div>
</div>
</div>

<div id="leftcolumn" >
<div class="innertube"><div id="arduinoList" > </div></div>

</div>

<div id="contentcolumn" >
<hr style="margin-bottom: 20px">
<div style="margin-bottom:20px">
Name: 
  <input type="text" id="fileName" value="" maxlength="40" size="27" />
  <select id="fileList" style="margin-left:55px" >
   <option  value="..">scripts</option>
  
  
  </select>

</div>

<div class="innertube">

  <div id="scriptEditorContainer"   class="shadowed">
  <textarea id="scriptEditor"  ></textarea>
  </div>

  <div id="scriptTarget" style="border: solid 1px #ccc; margin-left:0; border-radius: 2px;">drag and drop to upload script</div>
  <span id="uploadButton" >upload</span>
  <span id="saveButton">save</span>
  <span id="clearButton">clear</span>
  <span style="float:right" id="deleteButton">delete</span>
  
  </div>
 
  <hr style="margin-top:20px;"/>
  <div style="margin-top:40px;margin-left:10px">
  <div id="sendTarget" style="border: solid 1px #ccc;margin-left:0px;border-radius: 2px;">write to arduino</div>
      <input type="text" id="sendCommand" value="" maxlength="40"; size="40" />
       <span style="" id="sendButton">write</span>
  
  </div>
  
  </div>
</div>

<div id="footer">

</div>




</body>
</html>
